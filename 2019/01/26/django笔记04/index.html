<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/qi.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/qi.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Django配置连接数据库settings.py文件中数据库相关的配置 12345678910111213141516DATABASES = &amp;#123;    &apos;default&apos;: &amp;#123;        # 数据库引擎（是mysql还是oracle等）        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,        # 数据库的名字        &apos;">
<meta name="keywords" content="django">
<meta property="og:type" content="article">
<meta property="og:title" content="django笔记04 - 数据库">
<meta property="og:url" content="http://wuliuqi.top/2019/01/26/django笔记04/index.html">
<meta property="og:site_name" content="阿珍爱上了阿强">
<meta property="og:description" content="Django配置连接数据库settings.py文件中数据库相关的配置 12345678910111213141516DATABASES = &amp;#123;    &apos;default&apos;: &amp;#123;        # 数据库引擎（是mysql还是oracle等）        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,        # 数据库的名字        &apos;">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-02-16T03:48:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="django笔记04 - 数据库">
<meta name="twitter:description" content="Django配置连接数据库settings.py文件中数据库相关的配置 12345678910111213141516DATABASES = &amp;#123;    &apos;default&apos;: &amp;#123;        # 数据库引擎（是mysql还是oracle等）        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,        # 数据库的名字        &apos;">






  <link rel="canonical" href="http://wuliuqi.top/2019/01/26/django笔记04/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>django笔记04 - 数据库 | 阿珍爱上了阿强</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阿珍爱上了阿强</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">在一个有星星的夜晚</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wuliuqi.top/2019/01/26/django笔记04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WP">
      <meta itemprop="description" content="飞机从头顶飞过<br>流星也划破那夜空">
      <meta itemprop="image" content="/images/memory.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿珍爱上了阿强">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">django笔记04 - 数据库

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-26 13:51:04" itemprop="dateCreated datePublished" datetime="2019-01-26T13:51:04+08:00">2019-01-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-02-16 11:48:15" itemprop="dateModified" datetime="2019-02-16T11:48:15+08:00">2019-02-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/26/django笔记04/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2019/01/26/django笔记04/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/01/26/django笔记04/" class="leancloud_visitors" data-flag-title="django笔记04 - 数据库">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">32k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">58 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Django配置连接数据库"><a href="#Django配置连接数据库" class="headerlink" title="Django配置连接数据库"></a>Django配置连接数据库</h1><p>settings.py文件中数据库相关的配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="comment"># 数据库引擎（是mysql还是oracle等）</span></span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="comment"># 数据库的名字</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'dfz'</span>,</span><br><span class="line">        <span class="comment"># 连接mysql数据库的用户名</span></span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="comment"># 连接mysql数据库的密码</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="comment"># mysql数据库的主机地址</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="comment"># mysql数据库的端口号</span></span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="在Django中操作数据库"><a href="#在Django中操作数据库" class="headerlink" title="在Django中操作数据库"></a>在Django中操作数据库</h1><p>下面是使用原生sql语句操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用django封装好的connection对象，会自动读取settings.py中数据库的配置信息</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取游标对象</span></span><br><span class="line">cursor = connection.cursor()</span><br><span class="line"><span class="comment"># 拿到游标对象后执行sql语句</span></span><br><span class="line">cursor.execute(<span class="string">"select * from book"</span>)</span><br><span class="line"><span class="comment"># 获取所有的数据</span></span><br><span class="line">rows = cursor.fetchall()</span><br><span class="line"><span class="comment"># 遍历查询到的数据</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<p>以上的<code>execute</code>以及<code>fetchall</code>方法都是<code>Python DB API</code>规范中定义好的。任何使用<code>Python</code>来操作<code>MySQL</code>的驱动程序都应该遵循这个规范。所以不管是使用<code>pymysql</code>或者是<code>mysqlclient</code>或者是<code>mysqldb</code>，他们的接口都是一样的。</p>
<h1 id="Python-DB-API下规范下cursor对象常用接口："><a href="#Python-DB-API下规范下cursor对象常用接口：" class="headerlink" title="Python DB API下规范下cursor对象常用接口："></a>Python DB API下规范下cursor对象常用接口：</h1><ol>
<li><code>description</code>：如果<code>cursor</code>执行了查询的<code>sql</code>代码。那么读取<code>cursor.description</code>属性的时候，将返回一个列表，这个列表中装的是元组，元组中装的分别是<code>(name,type_code,display_size,internal_size,precision,scale,null_ok)</code>，其中<code>name</code>代表的是查找出来的数据的字段名称，其他参数暂时用处不大。</li>
<li><code>rowcount</code>：代表的是在执行了<code>sql</code>语句后受影响的行数。</li>
<li><code>close</code>：关闭游标。关闭游标以后就再也不能使用了，否则会抛出异常。</li>
<li><code>execute(sql[,parameters])</code>：执行某个<code>sql</code>语句。如果在执行<code>sql</code>语句的时候还需要传递参数，那么可以传给<code>parameters</code>参数。示例代码如下：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor.execute(<span class="string">"select * from article where id=%s"</span>,(<span class="number">1</span>,))</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><code>fetchone</code>：在执行了查询操作以后，获取第一条数据。</li>
<li><code>fetchmany(size)</code>：在执行查询操作以后，获取多条数据。具体是多少条要看传的<code>size</code>参数。如果不传<code>size</code>参数，那么默认是获取第一条数据。</li>
<li><code>fetchall</code>：获取所有满足<code>sql</code>语句的数据。</li>
</ol>
<h1 id="ORM模型的创建和映射："><a href="#ORM模型的创建和映射：" class="headerlink" title="ORM模型的创建和映射："></a>ORM模型的创建和映射：</h1><h2 id="创建ORM模型："><a href="#创建ORM模型：" class="headerlink" title="创建ORM模型："></a>创建ORM模型：</h2><p><code>ORM</code>模型一般都是放在<code>app</code>的<code>models.py</code>文件中。每个<code>app</code>都可以拥有自己的模型。并且如果这个模型想要映射到数据库中，那么这个<code>app</code>必须要放在<code>settings.py</code>的<code>INSTALLED_APP</code>中进行安装。以下是写一个简单的书籍<code>ORM</code>模型。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>,null=<span class="literal">False</span>)</span><br><span class="line">    author = models.CharField(max_length=<span class="number">20</span>,null=<span class="literal">False</span>)</span><br><span class="line">    pub_time = models.DateTimeField(default=datetime.now)</span><br><span class="line">    price = models.FloatField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>以上便定义了一个模型。这个模型继承自<code>django.db.models.Model</code>，如果这个模型想要映射到数据库中，就必须继承自这个类。这个模型以后映射到数据库中，表名是模型名称的小写形式，为<code>book</code>。在这个表中，有四个字段，一个为<code>name</code>，这个字段是保存的是书的名称，是<code>varchar</code>类型，最长不能超过20个字符，并且不能为空。第二个字段是作者名字类型，同样也是<code>varchar</code>类型，长度不能超过20个。第三个是出版时间，数据类型是<code>datetime</code>类型，默认是保存这本书籍的时间。第五个是这本书的价格，是浮点类型。<br>还有一个字段我们没有写，就是主键<code>id</code>，在<code>django</code>中，如果一个模型没有定义主键，那么将会自动生成一个自动增长的<code>int</code>类型的主键，并且这个主键的名字就叫做<code>id</code>。</p>
<h2 id="映射模型到数据库中："><a href="#映射模型到数据库中：" class="headerlink" title="映射模型到数据库中："></a>映射模型到数据库中：</h2><p>将<code>ORM</code>模型映射到数据库中，总结起来就是以下几步：</p>
<ol>
<li>在<code>settings.py</code>中，配置好<code>DATABASES</code>，做好数据库相关的配置。</li>
<li>在<code>app</code>中的<code>models.py</code>中定义好模型，这个模型必须继承自<code>django.db.models</code>。</li>
<li>将这个<code>app</code>添加到<code>settings.py</code>的<code>INSTALLED_APP</code>中。</li>
<li>在命令行终端，进入到项目所在的路径，然后执行命令<code>python manage.py makemigrations</code>来生成迁移脚本文件。</li>
<li>同样在命令行中，执行命令<code>python manage.py migrate</code>来将迁移脚本文件映射到数据库中。</li>
</ol>
<h1 id="ORM对数据库的基本操作"><a href="#ORM对数据库的基本操作" class="headerlink" title="ORM对数据库的基本操作"></a>ORM对数据库的基本操作</h1><h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h2><p>只要使用ORM模型创建一个对象。然后再调用这个ORM模型的<code>save</code>方法就可以保存了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book = Book(name=<span class="string">'西游记'</span>,author=<span class="string">'吴承恩'</span>,price=<span class="number">100</span>)</span><br><span class="line">book.save()</span><br></pre></td></tr></table></figure>
<h2 id="查找数据："><a href="#查找数据：" class="headerlink" title="查找数据："></a>查找数据：</h2><p>所有的查找工作都是使用模型上的<code>objects</code>属性来完成的。当然也可以自定义查询对象。这部分功能会在后面讲到。</p>
<ol>
<li>根据主键进行查找：使用主键进行查找。可以使用<code>objects.get</code>方法。然后传递<code>pk=xx</code>的方式进行查找。示例代码如下：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">book = Book.objects.get(pk=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>根据其他字段进行查找：可以使用<code>objects.filter</code>方法进行查找。示例代码如下：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.filter(name=<span class="string">'三国演义'</span>)</span><br></pre></td></tr></table></figure>
<p>使用<code>filter</code>方法返回来的是一个<code>QuerySet</code>对象。这个对象类似于列表。我们可以使用这个对象的<code>first</code>方法来获取第一个值。</p>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p>首先查找到对应的数据模型。然后再执行这个模型的<code>delete</code>方法即可删除。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book = Book.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">book.delete()</span><br></pre></td></tr></table></figure>
<h2 id="修改数据："><a href="#修改数据：" class="headerlink" title="修改数据："></a>修改数据：</h2><p>首先查找到对应的数据模型。然后修改这个模型上的属性的值。再执行<code>save</code>方法即可修改完成。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book = Book.objects.get(pk=<span class="number">2</span>)</span><br><span class="line">book.price = <span class="number">200</span></span><br><span class="line">book.save()</span><br></pre></td></tr></table></figure>
<h1 id="常用Field笔记："><a href="#常用Field笔记：" class="headerlink" title="常用Field笔记："></a>常用Field笔记：</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 如果想要使用自己定义的Field来作为主键，那么必须设置primary_key=True</span></span><br><span class="line">    id = models.BigAutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 在定义字段的时候，如果没有指定null=True，那么默认情况下，null=False</span></span><br><span class="line">    <span class="comment"># 就是不能为空</span></span><br><span class="line">    <span class="comment"># 如果想要使用可以为null的BooleanField，那么应该使用NullBooleanField来代替</span></span><br><span class="line">    removed = models.NullBooleanField()</span><br><span class="line">    <span class="comment"># CharField：如果是超过了254个字符，那么就不建议使用啦</span></span><br><span class="line">    <span class="comment"># 就推荐使用TextField：longtext</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    <span class="comment"># auto_now_add：是在第一次添加数据进去的时候会自动获取当前的时间，创建时间</span></span><br><span class="line">    <span class="comment"># auto_now：每次这个对象调用save方法的时候都会将当前的时间更新，更新时间</span></span><br><span class="line">    create_time = models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="navie时间和aware时间"><a href="#navie时间和aware时间" class="headerlink" title="navie时间和aware时间"></a>navie时间和aware时间</h2><ol>
<li>navie时间：不知道自己的时间表示的是哪个时区的。也就是不知道自己几斤几两。比较幼稚。</li>
<li>aware时间：知道自己的时间表示的是哪个时区的。也就是比较清醒。</li>
</ol>
<h3 id="pytz库"><a href="#pytz库" class="headerlink" title="pytz库"></a>pytz库</h3><p>专门用来处理时区的库。这个库会经常更新一些时区的数据，不需要我们担心。并且这个库在安装Django的时候会默认的安装。如果没有安装，那么可以通过<code>pip install pytz</code>的方式进行安装。</p>
<h3 id="astimezone方法："><a href="#astimezone方法：" class="headerlink" title="astimezone方法："></a>astimezone方法：</h3><p>将一个时区的时间转换为另外一个时区的时间。这个方法只能被<code>aware</code>类型的时间调用。不能被<code>navie</code>类型的时间调用。<br>示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">now = datetime.now() <span class="comment"># 这是一个navie类型的时间</span></span><br><span class="line">utc_timezone = pytz.timezone(<span class="string">"UTC"</span>) <span class="comment"># 定义UTC的时区对象</span></span><br><span class="line">utc_now = now.astimezone(utc_timezone) <span class="comment"># 将当前的时间转换为UTC时区的时间</span></span><br><span class="line">&gt;&gt; ValueError: astimezone() cannot be applied to a naive datetime <span class="comment"># 会抛出一个异常，原因就是因为navie类型的时间不能调用astimezone方法</span></span><br><span class="line"></span><br><span class="line">now = now.replace(tzinfo=pytz.timezone(<span class="string">'Asia/Shanghai'</span>))</span><br><span class="line">utc_now = now.astimezone(utc_timezone)</span><br><span class="line"><span class="comment"># 这时候就可以正确的转换。</span></span><br></pre></td></tr></table></figure>
<h3 id="replace方法"><a href="#replace方法" class="headerlink" title="replace方法"></a>replace方法</h3><p>可以将一个时间的某些属性进行更改。</p>
<h3 id="django-utils-timezone-now方法"><a href="#django-utils-timezone-now方法" class="headerlink" title="django.utils.timezone.now方法"></a>django.utils.timezone.now方法</h3><p>会根据<code>settings.py</code>中是否设置了<code>USE_TZ=True</code>获取当前的时间。如果设置了，那么就获取一个<code>aware</code>类型的<code>UTC</code>时间。如果没有设置，那么就会获取一个<code>navie</code>类型的时间。</p>
<h3 id="django-utils-timezone-localtime方法"><a href="#django-utils-timezone-localtime方法" class="headerlink" title="django.utils.timezone.localtime方法"></a>django.utils.timezone.localtime方法</h3><p>会根据<code>setting.py</code>中的<code>TIME_ZONE</code>来将一个<code>aware</code>类型的时间转换为<code>TIME_ZONE</code>指定时区的时间。<br>html模板中，会自动转换为当前时区时间。<code>views</code>中可以使用<code>localtime</code>转换为当前时区</p>
<h2 id="DateField："><a href="#DateField：" class="headerlink" title="DateField："></a>DateField：</h2><p>日期类型。在<code>Python</code>中是<code>datetime.date</code>类型，可以记录年月日。在映射到数据库中也是<code>date</code>类型。使用这个<code>Field</code>可以传递以下几个参数：</p>
<ol>
<li><code>auto_now</code>：在每次这个数据保存的时候，都使用当前的时间。比如作为一个记录修改日期的字段，可以将这个属性设置为<code>True</code>。</li>
<li><code>auto_now_add</code>：在每次数据第一次被添加进去的时候，都使用当前的时间。比如作为一个记录第一次入库的字段，可以将这个属性设置为<code>True</code>。</li>
</ol>
<h2 id="DateTimeField："><a href="#DateTimeField：" class="headerlink" title="DateTimeField："></a>DateTimeField：</h2><p>日期时间类型，类似于<code>DateField</code>。不仅仅可以存储日期，还可以存储时间。映射到数据库中是<code>datetime</code>类型。这个<code>Field</code>也可以使用<code>auto_now</code>和<code>auto_now_add</code>两个属性。</p>
<h2 id="TimeField："><a href="#TimeField：" class="headerlink" title="TimeField："></a>TimeField：</h2><p>时间类型。在数据库中是<code>time</code>类型。在<code>Python</code>中是<code>datetime.time</code>类型。</p>
<h2 id="EmailField："><a href="#EmailField：" class="headerlink" title="EmailField："></a>EmailField：</h2><p>类似于<code>CharField</code>。在数据库底层也是一个<code>varchar</code>类型。最大长度是254个字符。</p>
<h2 id="FileField："><a href="#FileField：" class="headerlink" title="FileField："></a>FileField：</h2><p>用来存储文件的。这个请参考后面的文件上传章节部分。</p>
<h3 id="ImageField："><a href="#ImageField：" class="headerlink" title="ImageField："></a>ImageField：</h3><p>用来存储图片文件的。这个请参考后面的图片上传章节部分。</p>
<h3 id="FloatField："><a href="#FloatField：" class="headerlink" title="FloatField："></a>FloatField：</h3><p>浮点类型。映射到数据库中是<code>float</code>类型。</p>
<h3 id="IntegerField："><a href="#IntegerField：" class="headerlink" title="IntegerField："></a>IntegerField：</h3><p>整形。值的区间是<code>-2147483648——2147483647</code>。</p>
<h3 id="BigIntegerField："><a href="#BigIntegerField：" class="headerlink" title="BigIntegerField："></a>BigIntegerField：</h3><p>大整形。值的区间是<code>-9223372036854775808——9223372036854775807</code>。</p>
<h3 id="PositiveIntegerField："><a href="#PositiveIntegerField：" class="headerlink" title="PositiveIntegerField："></a>PositiveIntegerField：</h3><p>正整形。值的区间是<code>0——2147483647</code>。</p>
<h3 id="SmallIntegerField："><a href="#SmallIntegerField：" class="headerlink" title="SmallIntegerField："></a>SmallIntegerField：</h3><p>小整形。值的区间是<code>-32768——32767</code>。</p>
<h3 id="PositiveSmallIntegerField："><a href="#PositiveSmallIntegerField：" class="headerlink" title="PositiveSmallIntegerField："></a>PositiveSmallIntegerField：</h3><p>正小整形。值的区间是<code>0——32767</code>。</p>
<h3 id="TextField："><a href="#TextField：" class="headerlink" title="TextField："></a>TextField：</h3><p>大量的文本类型。映射到数据库中是longtext类型。</p>
<h3 id="UUIDField："><a href="#UUIDField：" class="headerlink" title="UUIDField："></a>UUIDField：</h3><p>只能存储<code>uuid</code>格式的字符串。<code>uuid</code>是一个32位的全球唯一的字符串，一般用来作为主键。</p>
<h3 id="URLField："><a href="#URLField：" class="headerlink" title="URLField："></a>URLField：</h3><p>类似于<code>CharField</code>，只不过只能用来存储<code>url</code>格式的字符串。并且默认的<code>max_length</code>是200。</p>
<h2 id="Field常用的参数"><a href="#Field常用的参数" class="headerlink" title="Field常用的参数"></a>Field常用的参数</h2><h3 id="null："><a href="#null：" class="headerlink" title="null："></a>null：</h3><p>如果设置为<code>True</code>，<code>Django</code>将会在映射表的时候指定是否为空。默认是为<code>False</code>。在使用字符串相关的<code>Field</code>（CharField/TextField）的时候，官方推荐尽量不要使用这个参数，也就是保持默认值<code>False</code>。因为<code>Django</code>在处理字符串相关的<code>Field</code>的时候，即使这个<code>Field</code>的<code>null=False</code>，如果你没有给这个<code>Field</code>传递任何值，那么<code>Django</code>也会使用一个空的字符串<code>&quot;&quot;</code>来作为默认值存储进去。因此如果再使用<code>null=True</code>，<code>Django</code>会产生两种空值的情形（NULL或者空字符串）。如果想要在表单验证的时候允许这个字符串为空，那么建议使用<code>blank=True</code>。如果你的<code>Field</code>是<code>BooleanField</code>，那么对应的可空的字段则为<code>NullBooleanField</code>。</p>
<h3 id="blank："><a href="#blank：" class="headerlink" title="blank："></a>blank：</h3><p>标识这个字段在表单验证的时候是否可以为空。默认是<code>False</code>。<br>这个和<code>null</code>是有区别的，<code>null</code>是一个纯数据库级别的。而<code>blank</code>是表单验证级别的。</p>
<h3 id="db-column："><a href="#db-column：" class="headerlink" title="db_column："></a>db_column：</h3><p>这个字段在数据库中的名字。如果没有设置这个参数，那么将会使用模型中属性的名字。</p>
<h3 id="default："><a href="#default：" class="headerlink" title="default："></a>default：</h3><p>默认值。可以为一个值，或者是一个函数，但是不支持<code>lambda</code>表达式。并且不支持列表/字典/集合等可变的数据结构。</p>
<h3 id="primary-key："><a href="#primary-key：" class="headerlink" title="primary_key："></a>primary_key：</h3><p>是否为主键。默认是<code>False</code>。</p>
<h3 id="unique："><a href="#unique：" class="headerlink" title="unique："></a>unique：</h3><p>在表中这个字段的值是否唯一。一般是设置手机号码/邮箱等。</p>
<h2 id="模型中Meta配置"><a href="#模型中Meta配置" class="headerlink" title="模型中Meta配置"></a>模型中<code>Meta</code>配置</h2><p>对于一些模型级别的配置。我们可以在模型中定义一个类，叫做<code>Meta</code>。然后在这个类中添加一些类属性来控制模型的作用。比如我们想要在数据库映射的时候使用自己指定的表名，而不是使用模型的名称。那么我们可以在<code>Meta</code>类中添加一个<code>db_table</code>的属性。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>,null=<span class="literal">False</span>)</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">100</span>,name=<span class="string">'description'</span>,db_column=<span class="string">"description1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    db_table = <span class="string">'book_model'</span></span><br></pre></td></tr></table></figure>
<p>以下将对<code>Meta</code>类中的一些常用配置进行解释。</p>
<h3 id="db-table："><a href="#db-table：" class="headerlink" title="db_table："></a>db_table：</h3><p>这个模型映射到数据库中的表名。如果没有指定这个参数，那么在映射的时候将会使用模型名来作为默认的表名。</p>
<h3 id="ordering："><a href="#ordering：" class="headerlink" title="ordering："></a>ordering：</h3><p>设置在提取数据的排序方式。后面章节会讲到如何查找数据。比如我想在查找数据的时候根据添加的时间排序，那么示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">name = models.CharField(max_length=<span class="number">20</span>,null=<span class="literal">False</span>)</span><br><span class="line">desc = models.CharField(max_length=<span class="number">100</span>,name=<span class="string">'description'</span>,db_column=<span class="string">"description1"</span>)</span><br><span class="line">pub_date = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">db_table = <span class="string">'book_model'</span></span><br><span class="line">ordering = [<span class="string">'pub_date'</span>]     <span class="comment">#['-pub_date']是反向排序</span></span><br></pre></td></tr></table></figure>
<h1 id="外键和表关系"><a href="#外键和表关系" class="headerlink" title="外键和表关系"></a>外键和表关系</h1><h2 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h2><p>在<code>MySQL</code>中，表有两种引擎，一种是<code>InnoDB</code>，另外一种是<code>myisam</code>。如果使用的是<code>InnoDB</code>引擎，是支持外键约束的。外键的存在使得<code>ORM</code>框架在处理表关系的时候异常的强大。因此这里我们首先来介绍下外键在Django中的使用。</p>
<p>类定义为<code>class ForeignKey(to,on_delete,**options)</code>。第一个参数是引用的是哪个模型，第二个参数是在使用外键引用的模型数据被删除了，这个字段该如何处理，比如有<code>CASCADE</code>、<code>SET_NULL</code>等。这里以一个实际案例来说明。比如有一个<code>User</code>和一个<code>Article</code>两个模型。一个<code>User</code>可以发表多篇文章，一个<code>Article</code>只能有一个<code>Author</code>，并且通过外键进行引用。那么相关的示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    author = models.ForeignKey(<span class="string">"User"</span>,on_delete=models.CASCADE)  <span class="comment">#外键</span></span><br></pre></td></tr></table></figure>
<p>以上使用ForeignKey来定义模型之间的关系。即在article的实例中可以通过author属性来操作对应的User模型。这样使用起来非常的方便。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">article = Article(title=<span class="string">'abc'</span>,content=<span class="string">'123'</span>)</span><br><span class="line">author = User(username=<span class="string">'张三'</span>,password=<span class="string">'111111'</span>)</span><br><span class="line">article.author = author</span><br><span class="line">article.save()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改article.author上的值</span></span><br><span class="line">article.author.username = <span class="string">'李四'</span></span><br><span class="line">article.save()</span><br></pre></td></tr></table></figure>
<p>为什么使用了<code>ForeignKey</code>后，就能通过<code>author</code>访问到对应的<code>user</code>对象呢。因此在底层，<code>Django</code>为<code>Article</code>表添加了一个属性名<code>_id</code>的字段（比如<code>author</code>的字段名称是<code>author_id</code>），这个字段是一个外键，记录着对应的作者的主键。以后通过<code>article.author</code>访问的时候，实际上是先通过<code>author_id</code>找到对应的数据，然后再提取<code>User</code>表中的这条数据，形成一个模型。</p>
<p>如果想要引用另外一个app的模型，那么应该在传递to参数的时候，使用<code>app.model_name</code>进行指定。以上例为例，如果<code>User</code>和<code>Article</code>不是在同一个<code>app</code>中，那么在引用的时候的示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User模型在user这个app中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Article模型在article这个app中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    author = models.ForeignKey(<span class="string">"user.User"</span>,on_delete=models.CASCADE)  <span class="comment">#引用时指定所在app，app.model_name</span></span><br></pre></td></tr></table></figure>
<p>如果模型的外键引用的是本身自己这个模型，那么<code>to</code>参数可以为<code>self</code>，或者是这个模型的名字。在论坛开发中，一般评论都可以进行二级评论，即可以针对另外一个评论进行评论，那么在定义模型的时候就需要使用外键来引用自身。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    content = models.TextField()</span><br><span class="line">    origin_comment = models.ForeignKey(<span class="string">'self'</span>,on_delete=models.CASCADE,null=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 或者</span></span><br><span class="line">    <span class="comment"># origin_comment = models.ForeignKey('Comment',on_delete=models.CASCADE,null=True)</span></span><br></pre></td></tr></table></figure>
<h2 id="外键删除操作"><a href="#外键删除操作" class="headerlink" title="外键删除操作"></a>外键删除操作</h2><p>如果一个模型使用了外键。那么在对方那个模型被删掉后，该进行什么样的操作。可以通过<code>on_delete</code>来指定。可以指定的类型如下：</p>
<ol>
<li><code>CASCADE</code>：级联操作。如果外键对应的那条数据被删除了，那么这条数据也会被删除。</li>
<li><code>PROTECT</code>：受保护。即只要这条数据引用了外键的那条数据，那么就不能删除外键的那条数据。</li>
<li><code>SET_NULL</code>：设置为空。如果外键的那条数据被删除了，那么在本条数据上就将这个字段设置为空。如果设置这个选项，前提是要指定这个字段可以为空。</li>
<li><code>SET_DEFAULT</code>：设置默认值。如果外键的那条数据被删除了，那么本条数据上就将这个字段设置为默认值。如果设置这个选项，前提是要指定这个字段一个默认值。</li>
<li><code>SET()</code>：如果外键的那条数据被删除了。那么将会获取SET函数中的值来作为这个外键的值。SET函数可以接收一个可以调用的对象（比如函数或者方法），如果是可以调用的对象，那么会将这个对象调用后的结果作为值返回回去。</li>
<li><code>DO_NOTHING</code>：不采取任何行为。一切全看数据库级别的约束。</li>
</ol>
<p><strong>以上这些选项只是Django级别的，数据级别依旧是RESTRICT！</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    category = models.ForeignKey(<span class="string">'Category'</span>, on_delete=models.SET(Category.objects.get(pk=<span class="number">4</span>)), null=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="表关系笔记："><a href="#表关系笔记：" class="headerlink" title="表关系笔记："></a>表关系笔记：</h2><h3 id="一对多："><a href="#一对多：" class="headerlink" title="一对多："></a>一对多：</h3><ol>
<li>应用场景：比如文章和作者之间的关系。一个文章只能由一个作者编写，但是一个作者可以写多篇文章。文章和作者之间的关系就是典型的多对一的关系。</li>
<li>实现方式：一对多或者多对一，都是通过<code>ForeignKey</code>来实现的。还是以文章和作者的案例进行讲解。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    author = models.ForeignKey(<span class="string">"User"</span>,on_delete=models.CASCADE)</span><br></pre></td></tr></table></figure>
<p>那么以后在给<code>Article</code>对象指定<code>author</code>，就可以使用以下代码来完成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">article = Article(title=<span class="string">'abc'</span>,content=<span class="string">'123'</span>)</span><br><span class="line">author = User(username=<span class="string">'zhiliao'</span>,password=<span class="string">'111111'</span>)</span><br><span class="line"><span class="comment"># 要先保存到数据库中</span></span><br><span class="line">author.save()</span><br><span class="line">article.author = author</span><br><span class="line">article.save()</span><br></pre></td></tr></table></figure>
<p>并且以后如果想要获取某个用户下所有的文章，可以通过<code>article_set</code>来实现。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = User.objects.first()</span><br><span class="line"><span class="comment"># 获取第一个用户写的所有文章</span></span><br><span class="line">articles = user.article_set.all()</span><br><span class="line"><span class="keyword">for</span> article <span class="keyword">in</span> articles:</span><br><span class="line">    print(article)</span><br></pre></td></tr></table></figure>
<p>并且如果想要将文章添加到某个分类中。可以使用一下的方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">category = Category.objects.first()</span><br><span class="line">article = Article(title=<span class="string">'bbb'</span>,content=<span class="string">'vvv'</span>)</span><br><span class="line">article.author = FrontUser.objects.first()</span><br><span class="line">category.article_set.add(article,bulk=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>bulk=False</code>，那么Django会自动的保存article，而不需要在添加到category之前先保存article。</li>
<li>或者是另外一种解决方式是，在添加到<code>category.article_set</code>中之前，先将<code>article</code>保存到数据库中。但是如果<code>article.category</code>不能为空，那么就产生一种死循环了，article没有<code>category</code>不能保存，而将article添加到<code>cateogry.artile_set</code>中，又需要article之前是已经存储到数据库中的。</li>
<li>如果是上面的那种需求，建议使用<code>bulk=False</code>的解决方案。</li>
</ul>
<h3 id="一对一："><a href="#一对一：" class="headerlink" title="一对一："></a>一对一：</h3><ol>
<li>在Django中一对一是通过<code>models.OnetToOneField</code>来实现的。这个<code>OneToOneField</code>其实本质上就是一个外键，只不过这个外键有一个<code>唯一约束（unique key）</code>，来实现一对一。</li>
<li>以后如果想要反向引用，那么是通过引用的模型的名字转换为小写的形式进行访问。比如以下模型：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FrontUser</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserExtension</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    school = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    user = models.OneToOneField(<span class="string">"FrontUser"</span>,on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过userextension来访问UserExtension对象</span></span><br><span class="line">user = FrontUser.objects.first()</span><br><span class="line">print(user.userextension)</span><br></pre></td></tr></table></figure>
<p><code>UserExtension</code>的对象，可以通过<code>user</code>来访问到对应的user对象。并且<code>FrontUser</code>对象可以使用<code>userextension</code>来访问对应的<code>UserExtension</code>对象。<br>如果不想使用Django默认的引用属性名字。那么可以在<code>OneToOneField</code>中添加一个<code>related_name</code>参数。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FrontUser</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserExtension</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    school = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    user = models.OneToOneField(<span class="string">"FrontUser"</span>,on_delete=models.CASCADE,related_name=<span class="string">'extension'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过extension来访问到UserExtension对象</span></span><br><span class="line">user = FrontUser.objects.first()</span><br><span class="line">print(user.extension)</span><br></pre></td></tr></table></figure>
<p>那么以后就<code>FrontUser</code>的对象就可以通过<code>extension</code>属性来访问到对应的<code>UserExtension</code>对象。</p>
<h3 id="多对多："><a href="#多对多：" class="headerlink" title="多对多："></a>多对多：</h3><ol>
<li><p>应用场景：比如文章和标签的关系。一篇文章可以有多个标签，一个标签可以被多个文章所引用。因此标签和文章的关系是典型的多对多的关系。</p>
</li>
<li><p>实现方式：<code>Django</code>为这种多对多的实现提供了专门的<code>Field</code>。叫做<code>ManyToManyField</code>。还是拿文章和标签为例进行讲解。示例代码如下：</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    tags = models.ManyToManyField(<span class="string">"Tag"</span>,related_name=<span class="string">"articles"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">50</span>)</span><br></pre></td></tr></table></figure>
<p>在数据库层面，实际上<code>Django</code>是为这种多对多的关系建立了一个中间表。这个中间表分别定义了两个外键，引用到<code>article</code>和<code>tag</code>两张表的主键。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">many_to_many_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># article = Article.objects.first()  #获得文章</span></span><br><span class="line">    <span class="comment"># tag = Tag(name='冷门文章')    #新建标签</span></span><br><span class="line">    <span class="comment"># tag.save()</span></span><br><span class="line">    <span class="comment"># article.tag_set.add(tag)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># tag = Tag.objects.get(pk=1)</span></span><br><span class="line">    <span class="comment"># article = Article.objects.get(pk=3)</span></span><br><span class="line">    <span class="comment"># tag.articles.add(article)</span></span><br><span class="line"></span><br><span class="line">    article = Article.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">    tags = article.tags.all()</span><br><span class="line">    <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">        print(tag)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"success"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="查询条件笔记："><a href="#查询条件笔记：" class="headerlink" title="查询条件笔记："></a>查询条件笔记：</h1><h2 id="exact"><a href="#exact" class="headerlink" title="exact"></a>exact</h2><p><code>exact</code>：在底层会被翻译成<code>=</code>。</p>
<h2 id="iexact"><a href="#iexact" class="headerlink" title="iexact"></a>iexact</h2><p><code>iexact</code>：在底层会被翻译成<code>LIKE</code>。</p>
<ul>
<li><code>LIKE</code>和<code>=</code>：大部分情况下都是等价的，只有少数情况下是不等价的。</li>
<li><code>exict</code>和<code>iexact</code>：他们的区别其实就是<code>LIKE</code>和<code>=</code>的区别，因为exact会被翻译成<code>=</code>，而<code>iexact</code>会被翻译成<code>LIKE</code>。</li>
<li>因为<code>field__exact=xxx</code>其实等价于<code>filed=xxx</code>，因此我们直接使用<code>filed=xxx</code>就可以了，并且因为大部分情况<code>exact</code>和<code>iexact</code>又是等价的，因此我们以后直接使用<code>field=xxx</code>就可以了。</li>
</ul>
<h2 id="QuerySet-query"><a href="#QuerySet-query" class="headerlink" title="QuerySet.query"></a>QuerySet.query</h2><p><code>QuerySet.query</code>：<code>query</code>可以用来查看这个<code>ORM</code>查询语句最终被翻译成的<code>SQL</code>语句。但是<code>query</code>只能被用在<code>QuerySet</code>对象上，不能用在普通的<code>ORM模型</code>上。因此如果你的查询语句是通过<code>get</code>来获取数据的，那么就不能使用<code>query</code>，因为<code>get</code>返回的是满足条件的<code>ORM</code>模型，而不是<code>QuerySet</code>。如果你是通过<code>filter</code>等其他返回<code>QuerySet</code>的方法查询的，那么就可以使用<code>query</code>。</p>
<h2 id="contains"><a href="#contains" class="headerlink" title="contains"></a>contains</h2><p><code>contains</code>：使用大小写敏感的判断，某个字符串是否在指定的字段中。这个判断条件会使用大小敏感，因此在被翻译成<code>SQL</code>语句的时候，会使用<code>like binary</code>，而<code>like binary</code>就是使用大小写敏感的。</p>
<h2 id="icontains"><a href="#icontains" class="headerlink" title="icontains"></a>icontains</h2><p><code>icontains</code>：使用大小写不敏感的判断，某个字符串是否被包含在指定的字段中。这个查询语句在被翻译成<code>SQL</code>的时候，使用的是<code>like</code>，而<code>like</code>在<code>MySQL</code>层面就是不区分大小写的。</p>
<h2 id="contains和iexact区别"><a href="#contains和iexact区别" class="headerlink" title="contains和iexact区别"></a>contains和iexact区别</h2><p><code>contains</code>和<code>icontains</code>，在被翻译成<code>SQL</code>的时候使用的是<code>%hello%</code>，就是只要整个字符串中出现了<code>hello</code>都能过够被找到，而<code>iexact</code>没有百分号，那么意味着只有完全相等的时候才会被匹配到。</p>
<h2 id="in"><a href="#in" class="headerlink" title="in"></a>in</h2><p><code>in</code>：可以直接指定某个字段的是否在某个集合中。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(id__in=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p>也可以通过其他的表的字段来判断是否在某个集合中。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">categories = Category.objects.filter(article__id__in=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p>如果要判断相关联的表的字段，那么也是通过<code>__</code>来连接。并且在做关联查询的时候，不需要写<code>models_set</code>，直接使用<code>模型的名字的小写化</code>就可以了。比如通过分类去查找相应的文章，那么通过<code>article__id__in</code>就可以了，而不是写成<code>article_set__id__in</code>的形式。当然如果你不想使用默认的形式，可以在外键定义的时候传递<code>related_query_name</code>来指定反向查询的名字。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'category'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    cateogry = models.ForeignKey(<span class="string">"Category"</span>,on_delete=models.CASCADE,null=<span class="literal">True</span>,related_query_name=<span class="string">'articles'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'article'</span></span><br></pre></td></tr></table></figure>
<p>因为在<code>cateogry</code>的<code>ForeignKey</code>中指定了<code>related_query_name</code>为<code>articles</code>，因此你不能再使用<code>article</code>来进行反向查询了。这时候就需要通过<code>articles__id__in</code>来进行反向查询。</p>
<p>反向查询是将模型名字小写化。比如<code>article__in</code>。可以通过<code>related_query_name</code>来指定自己的方式，而不使用默认的方式。<br>反向引用是将模型名字小写化，然后再加上<code>_set</code>，比如<code>article_set</code>，可以通过<code>related_name</code>来指定自己的方式，而不是用默认的方式。</p>
<p>并且，如果在做反向查询的时候，如果查询的字段就是模型的主键，那么可以省略掉这个字段，直接写成<code>article__in</code>就可以了，不需要这个<code>id</code>了。</p>
<p><code>in</code>不仅仅可以指定列表/元组，还可以为<code>QuerySet</code>。比如要查询“文章标题中包含有hello的所有分类”，那么可以通过以下代码来实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(title__icontains=<span class="string">'hello'</span>)</span><br><span class="line">categories = Category.objects.filter(articles__in=articles)</span><br><span class="line"><span class="keyword">for</span> cateogry <span class="keyword">in</span> categories:</span><br><span class="line">    print(cateogry)</span><br></pre></td></tr></table></figure>
<h2 id="gt、gte、lt、lte"><a href="#gt、gte、lt、lte" class="headerlink" title="gt、gte、lt、lte"></a><code>gt</code>、<code>gte</code>、<code>lt</code>、<code>lte</code></h2><p><code>gt</code>、<code>gte</code>、<code>lt</code>、<code>lte</code>：代表的是大于、大于等于、小于、小于等于的条件。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(id__lte=<span class="number">3</span>)  <span class="comment">#小于等于3</span></span><br></pre></td></tr></table></figure>
<h2 id="startswith、istartswith、endswith、iendswith"><a href="#startswith、istartswith、endswith、iendswith" class="headerlink" title="startswith、istartswith、endswith、iendswith"></a><code>startswith</code>、<code>istartswith</code>、<code>endswith</code>、<code>iendswith</code></h2><p><code>startswith</code>、<code>istartswith</code>、<code>endswith</code>、<code>iendswith</code>：表示以某个值开始，不区分大小写的以某个值开始、以某个值结束、不区分大小写的以某个值结束。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(title__endswith=<span class="string">"hello"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="时间查询条件"><a href="#时间查询条件" class="headerlink" title="时间查询条件"></a>时间查询条件</h2><h3 id="range"><a href="#range" class="headerlink" title="range"></a>range</h3><p><code>range</code>：可以指定一个时间段。并且时间应该标记为<code>aware</code>时间，不然django会报警告。Filtering a DateTimeField with dates won’t include items on the last day. 示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,time</span><br><span class="line"><span class="keyword">from</span> django.utils.timezone <span class="keyword">import</span> make_aware</span><br><span class="line"></span><br><span class="line">start_time = make_aware(datetime(year=<span class="number">2018</span>,month=<span class="number">4</span>,day=<span class="number">4</span>,hour=<span class="number">17</span>,minute=<span class="number">0</span>,second=<span class="number">0</span>))</span><br><span class="line">end_time = make_aware(datetime(year=<span class="number">2018</span>,month=<span class="number">4</span>,day=<span class="number">4</span>,hour=<span class="number">18</span>,minute=<span class="number">0</span>,second=<span class="number">0</span>))</span><br><span class="line">articles = Article.objects.filter(create_time__range=(start_time,end_time))</span><br><span class="line">print(articles.query)</span><br><span class="line">print(articles)</span><br></pre></td></tr></table></figure>
<h3 id="date"><a href="#date" class="headerlink" title="date"></a>date</h3><p><code>date</code>：用年月日来进行过滤。如果想要使用这个过滤条件，那么前提必须要在<code>MySQL</code>中添加好那些时区文件。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(create_time__date=datetime(year=<span class="number">2018</span>,month=<span class="number">4</span>,day=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<h3 id="year-month-day"><a href="#year-month-day" class="headerlink" title="year/month/day"></a>year/month/day</h3><p><code>year/month/day</code>：表示根据年/月/日进行查找。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(create_time__year__gte=<span class="number">2018</span>)</span><br></pre></td></tr></table></figure>
<h3 id="week-day"><a href="#week-day" class="headerlink" title="week_day"></a>week_day</h3><p><code>week_day</code>：根据星期来进行查找。1表示星期天，7表示星期六，2-6代表的是星期一到星期五。比如要查找星期三的所有文章，那么可以通过以下代码来实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(create_time__week_day=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<h3 id="time"><a href="#time" class="headerlink" title="time"></a>time</h3><p><code>time</code>：根据分时秒来进行查找。如果要具体到秒，一般比较难匹配到，可以使用区间的方式来进行查找。区间使用<code>range</code>条件。比如想要获取17时/10分/27-28秒之间的文章，那么可以通过以下代码来实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start_time = time(hour=<span class="number">17</span>,minute=<span class="number">10</span>,second=<span class="number">27</span>)</span><br><span class="line">end_time = time(hour=<span class="number">17</span>,minute=<span class="number">10</span>,second=<span class="number">28</span>)</span><br><span class="line">articles = Article.objects.filter(create_time__time__range=(start_time,end_time))</span><br></pre></td></tr></table></figure>
<h2 id="regex和iregex"><a href="#regex和iregex" class="headerlink" title="regex和iregex"></a><code>regex</code>和<code>iregex</code></h2><p><code>regex</code>和<code>iregex</code>：大小写敏感和大小写不敏感的正则表达式。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.filter(title__regex=<span class="string">r'^hello'</span>)</span><br></pre></td></tr></table></figure>
<p>以上代码的意思是提取所有标题以<code>hello</code>字符串开头的文章。</p>
<h1 id="聚合函数笔记："><a href="#聚合函数笔记：" class="headerlink" title="聚合函数笔记："></a>聚合函数笔记：</h1><ol>
<li>所有的聚合函数都是放在<code>django.db.models</code>下面。</li>
<li>聚合函数不能够单独的执行，需要放在一些可以执行聚合函数的方法下面中去执行。比如<code>aggregate</code>。示例代码如下：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg</span><br><span class="line"></span><br><span class="line">result = Book.objects.aggregate(Avg(<span class="string">"price"</span>))</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>聚合函数执行完成后，自动给这个聚合函数的值取个名字。取别名的规则，默认是<code>field+__+聚合函数名字</code>形成的。比如以上代码形成的名字叫做<code>price__avg</code>。如果不想使用默认的名字，那么可以在使用聚合函数的时候传递关键字参数进去，参数的名字就是聚合函数执行完成的名字。实示例代码如下：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Book.objects.aggregate(avg=Avg(<span class="string">"price"</span>))</span><br></pre></td></tr></table></figure>
<p>以上传递了关键字参数<code>avg=Avg(&quot;price&quot;)</code>，那么以后<code>Avg</code>聚合函数执行完成的名字就叫做<code>avg</code>。</p>
<h2 id="aggregate"><a href="#aggregate" class="headerlink" title="aggregate"></a>aggregate</h2><p><code>aggregate</code>：这个方法不会返回一个<code>QuerySet</code>对象，而是返回一个字典。这个字典中的<code>key</code>就是聚合函数的名字，值就是聚合函数执行后的结果。</p>
<h2 id="annotate"><a href="#annotate" class="headerlink" title="annotate"></a>annotate</h2><p><code>aggregate</code>和<code>annotate</code>的相同和不同：</p>
<pre><code>* 相同：这两个方法都可以执行聚合函数。
* 不同：
    - `aggregate`返回的是一个字典，在这个字典中存储的是这个聚合函数执行的结果。而`annotate`返回的是一个`QuerySet`对象，并且会在查找的模型上添加一个聚合函数的属性。
    - `aggregate`不会做分组，而`annotate`会使用`group by`子句进行分组，只有调用了`group by`子句，才能对每一条数据求聚合函数的值。`annotate`在原来模型字段的基础之上添加一个使用了聚合函数的字段，并且在使用聚合函数的时候，会使用当前这个模型的主键进行分组（group by）。
</code></pre><p><code>aggregate</code>和<code>annotate</code>方法可以在任何的<code>QuerySet</code>对象上调用。因此只要是返回了<code>QuerySet</code>对象，那么就可以进行链式调用。比如要获取2018年度的销售总额，那么可以先过滤年份，再求聚合函数。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BookOrder.objects.filter(create_time__year=<span class="number">2018</span>).aggregate(total=Sum(<span class="string">'price'</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h2><p><code>Count</code>：用来求某个数据的个数。比如要求所有图书的数量，那么可以使用以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Book.objects.aggregate(book_nums=Count(<span class="string">"id"</span>))</span><br></pre></td></tr></table></figure>
<p>并且<code>Count</code>可以传递<code>distinct=True</code>参数，用来剔除那些重复的值，只保留一个。比如要获取作者表中，不同邮箱的个数，那么这时候可以使用<code>distinct=True</code>。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Author.objects.aggregate(email_nums=Count(<span class="string">'email'</span>,distinct=<span class="literal">True</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Max和Min"><a href="#Max和Min" class="headerlink" title="Max和Min"></a><code>Max</code>和<code>Min</code></h2><p><code>Max</code>和<code>Min</code>：求指定字段的最大值和最小值。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = Author.objects.aggregate(max=Max(<span class="string">"age"</span>),min=Min(<span class="string">"age"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h2><p><code>Sum</code>：求某个字段值的总和。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = BookOrder.objects.aggregate(total=Sum(<span class="string">'price'</span>))</span><br></pre></td></tr></table></figure>
<h1 id="F表达式和Q表达式"><a href="#F表达式和Q表达式" class="headerlink" title="F表达式和Q表达式"></a>F表达式和Q表达式</h1><h2 id="F表达式"><a href="#F表达式" class="headerlink" title="F表达式"></a>F表达式</h2><p><code>F表达式</code>： 动态的获取某个字段上的值。并且这个F表达式，不会真正的去数据库中查询数据，他相当于只是起一个标识的作用。比如想要将原来每本图书的价格都在原来的基础之上增加10元，那么可以使用以下代码来实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"></span><br><span class="line">Book.objects.update(price=F(<span class="string">"price"</span>)+<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取名字和邮箱相同的作者</span></span><br><span class="line">authors = Author.objects.filter(name=F(<span class="string">"email"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Q表达式"><a href="#Q表达式" class="headerlink" title="Q表达式"></a>Q表达式</h2><p><code>Q表达式</code>：使用<code>Q</code>表达式包裹查询条件，可以在条件之间进行多种操作。与、或、非等，从而实现一些复杂的查询操作。例子如下：</p>
<ul>
<li>查找价格大于100，并且评分达到4.85以上的图书：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不使用Q表达式的</span></span><br><span class="line">books = Book.objects.filter(price__gte=<span class="number">100</span>,rating__gte=<span class="number">4.85</span>)</span><br><span class="line"><span class="comment"># 使用Q表达式的</span></span><br><span class="line">books = Book.objects.filter(Q(price__gte=<span class="number">100</span>)&amp;Q(rating__gte=<span class="number">4.85</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>查找价格低于100元，或者评分低于4分的图书：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.filter(Q(price__gte=<span class="number">100</span>)&amp;Q(rating__gte=<span class="number">4.85</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>获取价格大于100，并且图书名字中不包含”传“字的图书：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.filter(Q(price__gte=<span class="number">100</span>)&amp;~Q(name__icontains=<span class="string">'传'</span>))</span><br></pre></td></tr></table></figure>
<h1 id="QuerySet-API："><a href="#QuerySet-API：" class="headerlink" title="QuerySet API："></a>QuerySet API：</h1><h2 id="模型-objects："><a href="#模型-objects：" class="headerlink" title="模型.objects："></a>模型.objects：</h2><p>这个对象是<code>django.db.models.manager.Manager</code>的对象，这个类是一个空壳类，他上面的所有方法都是从<code>QuerySet</code>这个类上面拷贝过来的。因此我们只要学会了<code>QuerySet</code>，这个<code>objects</code>也就知道该如何使用了。</p>
<p><code>Manager</code>源码解析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class_name = <span class="string">"BaseManagerFromQuerySet"</span></span><br><span class="line"></span><br><span class="line">class_dict = &#123;</span><br><span class="line">    <span class="string">'_queryset_class'</span>: QuerySet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class_dict.update(cls._get_queryset_methods(QuerySet))</span><br><span class="line"></span><br><span class="line"><span class="comment"># type动态的时候创建类</span></span><br><span class="line"><span class="comment"># 第一个参数是用来指定创建的类的名字。创建的类名是：BaseManagerFromQuerySet</span></span><br><span class="line"><span class="comment"># 第二个参数是用来指定这个类的父类。</span></span><br><span class="line"><span class="comment"># 第三个参数是用来指定这个类的一些属性和方法</span></span><br><span class="line"><span class="keyword">return</span> type(class_name,(cls,),class_dict)</span><br><span class="line"></span><br><span class="line">_get_queryset_methods：这个方法就是将QuerySet中的一些方法拷贝出来</span><br></pre></td></tr></table></figure>
<h2 id="filter-exclude-annotate：过滤-排除满足条件的-给模型添加新的字段。"><a href="#filter-exclude-annotate：过滤-排除满足条件的-给模型添加新的字段。" class="headerlink" title="filter/exclude/annotate：过滤/排除满足条件的/给模型添加新的字段。"></a><code>filter/exclude/annotate</code>：过滤/排除满足条件的/给模型添加新的字段。</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.exclude(title__contains=<span class="string">'hello'</span>)</span><br><span class="line"></span><br><span class="line">articles = Article.objects.annotate(author_name=F(<span class="string">"author__name"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="order-by："><a href="#order-by：" class="headerlink" title="order_by："></a>order_by：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据创建的时间正序排序</span></span><br><span class="line">articles = Article.objects.order_by(<span class="string">"create_time"</span>)</span><br><span class="line"><span class="comment"># 根据创建的时间倒序排序</span></span><br><span class="line">articles = Article.objects.order_by(<span class="string">"-create_time"</span>)</span><br><span class="line"><span class="comment"># 根据作者的名字进行排序</span></span><br><span class="line">articles = Article.objects.order_by(<span class="string">"author__name"</span>)</span><br><span class="line"><span class="comment"># 首先根据创建的时间进行排序，如果时间相同，则根据作者的名字进行排序</span></span><br><span class="line">articles = Article.objects.order_by(<span class="string">"create_time"</span>,<span class="string">'author__name'</span>)</span><br></pre></td></tr></table></figure>
<p>一定要注意的一点是，多个<code>order_by</code>，会把前面排序的规则给打乱，而使用后面的排序方式。比如以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.order_by(<span class="string">"create_time"</span>).order_by(<span class="string">"author__name"</span>)</span><br></pre></td></tr></table></figure>
<p>它会根据作者的名字进行排序，而不是使用文章的创建时间。</p>
<p>当然，也可以在模型定义的在<code>Meta</code>类中定义<code>ordering</code>来指定默认的排序方式。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    db_table = <span class="string">'book_order'</span></span><br><span class="line">    ordering = [<span class="string">'create_time'</span>,<span class="string">'-price'</span>]</span><br></pre></td></tr></table></figure>
<p>还可以根据<code>annotate</code>定义的字段进行排序。比如要实现图书的销量进行排序，那么示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.annotate(order_nums=Count(<span class="string">"bookorder"</span>)).order_by(<span class="string">"-order_nums"</span>)</span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">        print(<span class="string">'%s/%s'</span>%(book.name,book.order_nums))</span><br></pre></td></tr></table></figure>
<h2 id="values"><a href="#values" class="headerlink" title="values"></a>values</h2><p>只想提取其中的几个字段，可以使用<code>values</code>来进行指定，并且使用了<code>values</code>方法后，提取出的<code>QuerySet</code>中的数据类型不是模型，而是在<code>values</code>方法中指定的字段和值形成的字典：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values(<span class="string">'id'</span>,<span class="string">'name'</span>)</span><br></pre></td></tr></table></figure>
<p>提取这个模型上关联的的对象的属性，查找顺序和<code>filter</code>的用法是一样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values(<span class="string">'id'</span>,<span class="string">'name'</span>,<span class="string">'author__name'</span>)</span><br></pre></td></tr></table></figure>
<p>以上会提取<code>author</code>的<code>name</code>字段，如果想更改字段名，可以使用关键字参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values(<span class="string">'id'</span>, <span class="string">'name'</span>, author_name=F(<span class="string">'author__name'</span>))</span><br></pre></td></tr></table></figure>
<p>自定义的名字，不能和模型上本身拥有的字段一样，否则会报错。</p>
<p>在<code>values</code>中，也可以使用聚合函数来形成一个新的字段。比如获取每本图书的销量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values(<span class="string">'id'</span>, <span class="string">'name'</span>, order_nums=Count(<span class="string">'bookorder'</span>))</span><br></pre></td></tr></table></figure>
<p>如果调用<code>values</code>方法的时候，没有传递任何的参数，那么会获取这个模型上的所有字段以及对于的值形成的字典：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values()</span><br></pre></td></tr></table></figure>
<p>那么<code>books</code>中的值如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'id'</span>:<span class="number">1</span>, <span class="string">'name'</span>:<span class="string">'三国演义'</span>, <span class="string">'pages'</span>:<span class="number">987</span>, <span class="string">'price'</span>:<span class="number">108.0</span>, <span class="string">'rating'</span>:<span class="number">3.9</span>, <span class="string">'author_id'</span>:<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="values-list"><a href="#values-list" class="headerlink" title="values_list"></a>values_list</h2><p>和<code>values</code>是一样的作用，只不过返回的<code>QuerySet</code>中，装的不是字典，而是元组。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values_list(<span class="string">'id'</span>, <span class="string">'name'</span>)</span><br></pre></td></tr></table></figure>
<p>以上的返回结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>,<span class="string">'三国演义'</span>)</span><br></pre></td></tr></table></figure>
<p>如果给<code>values_list</code>只指定一个字段，那么我们可以指定<code>flat=True</code>，这样返回的结果就不再是一个元组，而是整个字段的值。<code>flat</code>只能用在只有一个字段的情况下，否则就会报错。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.values_list(<span class="string">'name'</span>, flat=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>那么以上返回的结果是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'三国演义'</span></span><br></pre></td></tr></table></figure>
<h2 id="all方法"><a href="#all方法" class="headerlink" title="all方法"></a><code>all</code>方法</h2><p>这个简单的返回一个<code>QuerySet</code>对象，这个<code>QuerySet</code>对象没有经过任何的修改（比如：过滤等）。</p>
<h2 id="select-related"><a href="#select-related" class="headerlink" title="select_related"></a>select_related</h2><p>在查找某个表的数据的时候，可以一次性把相关联的其它表的数据都提取出来。以后再访问相关表的数据的时候，不用再次查找数据库，可以节省一些开销。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.select_related(<span class="string">'author'</span>,<span class="string">'publisher'</span>)</span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">    print(book.author.name)</span><br><span class="line">    <span class="comment"># 因为在提取Book的时候，使用了select_related，那么以后再访问book.author的时候，不会再次向数据库重新发起查询</span></span><br></pre></td></tr></table></figure>
<p>注意：这个方法只能用在外键的关联对象上，对于那种多对多，或者是多对一的情况，不能使用它来实现，应该使用<code>prefetch_related</code>来实现。</p>
<h2 id="prefetch-related"><a href="#prefetch-related" class="headerlink" title="prefetch_related"></a>prefetch_related</h2><p>与<code>select_related</code>方法类似，也是在查询语句时，提前将指定的数据查找出来。只不过这个方法是用来解决多对多，或者多对一的情况。这个方法会产生两个查询语句。所以，如果在这个方法中查询使用外键关联的模型的时候，也会产生两个查询语句，因此如果查询的是外键关联的模型，建议使用<code>select_related</code>方法。<br>在查询多对多或者多对一的关联的对象的时候，与使用模型访问传递的字符串一样。比如要获取图书上的所有订单，示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.prefetch_related(<span class="string">'bookorder_set'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：在使用<code>prefetch_related</code>查找出来的<code>bookorder_set</code>，建议不要再对其进行任何操作，比如<code>filter</code>，不然又会产生N多查询语句。</p>
<p>如果确实想要对预先查找的集合进行操作，可以用<code>django.db.models.Prefetch</code>完成。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Prefetch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先使用Prefetch吧查找的条件写好，在放到prefetch_related中</span></span><br><span class="line">prefetch = Prefetch(<span class="string">"bookorder_set"</span>,queryset=BookOrder.objects.filter(price__gte=<span class="number">90</span>))</span><br><span class="line">books = Book.objects.prefetch_related(prefetch)</span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">    print(<span class="string">'='</span>*<span class="number">30</span>)</span><br><span class="line">    print(book.name)</span><br><span class="line">    orders = book.bookorder_set.all()</span><br><span class="line">    <span class="keyword">for</span> order <span class="keyword">in</span> orders:</span><br><span class="line">        print(order.id)</span><br></pre></td></tr></table></figure>
<h2 id="defer和only"><a href="#defer和only" class="headerlink" title="defer和only"></a>defer和only</h2><p>这两个方法都会返回一个<code>QuerySet</code>对象，并且这个<code>QuerySet</code>中装的都是模型，而不是字典。</p>
<ol>
<li><code>defer</code>：这个方法用来告诉<code>ORM</code>，在查询某个模型的时候，过滤掉某些字段。注意：使用了<code>defer</code>了的字段，如果以后再使用这个字段，会重新发起一次请求。因此要谨慎操作。</li>
<li><code>only</code>：这个方法用来告诉<code>ORM</code>，在查询某个模型的时候，值提取几个字段。注意：没有加在<code>only</code>中的字段，以后如果使用了，那么也会重新发起一次请求。因此要谨慎操作。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.only(<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">    print(<span class="string">'%s/%s'</span>%(book.id,book.price))</span><br></pre></td></tr></table></figure>
<h2 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h2><p>这个方法给定的条件只能匹配到一条数据，如果匹配到多条数据，或没有匹配到任何数据，都会报错。一般用于查询主键。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book = Book.objects.get(id=<span class="number">5</span>)</span><br><span class="line">print(book)</span><br><span class="line">print(connection.queries)</span><br></pre></td></tr></table></figure>
<h2 id="create方法"><a href="#create方法" class="headerlink" title="create方法"></a>create方法</h2><p>创建一条数据，并且将这个数据保存到数据库中，以下的代码是等价的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">publisher = Publisher(name=<span class="string">'人民邮电出版社'</span>)</span><br><span class="line">publisher.save()</span><br><span class="line"></span><br><span class="line">Publisher.objects.create(name=<span class="string">'人民邮电出版社'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="get-or-create"><a href="#get-or-create" class="headerlink" title="get_or_create"></a>get_or_create</h2><p>如果给定的条件有数据，那么就会把这个数据直接提取出来。如果给定的条件没有数据，那么就会先创建数据，然后再把数据返回回来。这个方法的返回值是一个元组，元组的第一个参数<code>obj</code>是这个对象，第二个参数<code>created</code>代表是否创建的，是返回<code>True</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj,created= Category.objects.get_or_create(title=<span class="string">'默认分类'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="bulk-create"><a href="#bulk-create" class="headerlink" title="bulk_create"></a>bulk_create</h2><p>一次性创建多个数据。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">publisher = Publisher.objects.bulk_create([</span><br><span class="line">    Publisher(name=<span class="string">'123出版社'</span>),</span><br><span class="line">    Publisher(name=<span class="string">'abc出版社'</span>),</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h2 id="count"><a href="#count" class="headerlink" title="count"></a>count</h2><p>获取提取的数据的个数。如果想要知道总共有多少条数据，那么建议使用<code>count</code>，而不是使用<code>len(articles)</code>这种。因为<code>count</code>在底层是使用<code>select count(*)</code>来实现的，这种方式比使用<code>len</code>函数更加的高效。</p>
<h2 id="firtst和last"><a href="#firtst和last" class="headerlink" title="firtst和last"></a>firtst和last</h2><p>返回<code>QuerySet</code>中的第一条和最后一条数据。</p>
<h2 id="aggregate-1"><a href="#aggregate-1" class="headerlink" title="aggregate"></a>aggregate</h2><p>使用聚合函数。</p>
<h2 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h2><p>判断某个条件的数据是否存在。如果要判断某个条件的元素是否存在，那么建议使用<code>exists</code>，这比使用<code>count</code>或者直接判断<code>QuerySet</code>更有效得多。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> Article.objects.filter(title__contains=<span class="string">'hello'</span>).exists():</span><br><span class="line">    print(<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 比使用count更高效：</span></span><br><span class="line"><span class="keyword">if</span> Article.objects.filter(title__contains=<span class="string">'hello'</span>).count() &gt; <span class="number">0</span>:</span><br><span class="line">    print(<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 也比直接判断QuerySet更高效：</span></span><br><span class="line"><span class="keyword">if</span> Article.objects.filter(title__contains=<span class="string">'hello'</span>):</span><br><span class="line">    print(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h2><p>去除掉那些重复的数据。这个方法如果底层数据库用的是<code>MySQL</code>，那么不能传递任何的参数。比如想要提取所有销售的价格超过80元的图书，并且删掉那些重复的，那么可以使用<code>distinct</code>来帮我们实现，示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.filter(bookorder__price__gte=<span class="number">80</span>).distinct()</span><br></pre></td></tr></table></figure>
<p>需要注意的是，如果在<code>distinct</code>之前使用了<code>order_by</code>，那么因为<code>order_by</code>会提取<code>order_by</code>中指定的字段，因此再使用<code>distinct</code>就会根据多个字段来进行唯一化，所以就不会把那些重复的数据删掉。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orders = BookOrder.objects.order_by(<span class="string">"create_time"</span>).values(<span class="string">"book_id"</span>).distinct()</span><br></pre></td></tr></table></figure>
<p>那么以上代码因为使用了<code>order_by</code>，即使使用了<code>distinct</code>，也会把重复的<code>book_id</code>提取出来。</p>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>执行更新操作，在<code>SQL</code>底层走的也是<code>update</code>命令。比如要将所有<code>category</code>为空的<code>article</code>的<code>article</code>字段都更新为默认的分类。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.filter(category__isnull=<span class="literal">True</span>).update(category_id=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>注意这个方法走的是更新的逻辑。所以更新完成后保存到数据库中不会执行<code>save</code>方法，因此不会更新<code>auto_now</code>设置的字段。</p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p>删除所有满足条件的数据。删除数据的时候，要注意<code>on_delete</code>指定的处理方式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Author.objects.filter(id__gte=<span class="number">3</span>).delete()</span><br></pre></td></tr></table></figure>
<h2 id="切片操作"><a href="#切片操作" class="headerlink" title="切片操作"></a>切片操作</h2><p>有时候我们查找数据，有可能只需要其中的一部分。那么这时候可以使用切片操作来帮我们完成。<code>QuerySet</code>使用切片操作就跟列表使用切片操作是一样的。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.all()[<span class="number">1</span>:<span class="number">3</span>]   <span class="comment">#1,2</span></span><br><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">    print(book)</span><br></pre></td></tr></table></figure>
<p>切片操作并不是把所有数据从数据库中提取出来再做切片操作。而是在数据库层面使用<code>LIMIT</code>和<code>OFFSET</code>来帮我们完成。所以如果只需要取其中一部分的数据的时候，建议大家使用切片操作。</p>
<h2 id="什么时候Django会将QuerySet转换为SQL去执行"><a href="#什么时候Django会将QuerySet转换为SQL去执行" class="headerlink" title="什么时候Django会将QuerySet转换为SQL去执行"></a>什么时候<code>Django</code>会将<code>QuerySet</code>转换为<code>SQL</code>去执行</h2><p>生成一个<code>QuerySet</code>对象并不会马上转换为<code>SQL</code>语句去执行。<br>比如我们获取<code>Book</code>表下所有的图书：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">books = Book.objects.all()</span><br><span class="line">print(connection.queries)</span><br></pre></td></tr></table></figure>
<p>我们可以看到在打印<code>connection.quries</code>的时候打印的是一个空的列表。说明上面的<code>QuerySet</code>并没有真正的执行。<br>在以下情况下<code>QuerySet</code>会被转换为<code>SQL</code>语句执行：</p>
<ul>
<li>迭代：在遍历<code>QuerySet</code>对象的时候，会首先先执行这个<code>SQL</code>语句，然后再把这个结果返回进行迭代。比如以下代码就会转换为<code>SQL</code>语句：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> book <span class="keyword">in</span> Book.objects.all():</span><br><span class="line">    print(book)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用步长做切片操作：<code>QuerySet</code>可以类似于列表一样做切片操作。做切片操作本身不会执行<code>SQL</code>语句，但是如果如果在做切片操作的时候提供了步长，那么就会立马执行SQL语句。需要注意的是，做切片后不能再执行<code>filter</code>方法，否则会报错。</li>
<li>调用<code>len</code>函数：调用<code>len</code>函数用来获取<code>QuerySet</code>中总共有多少条数据也会执行<code>SQL</code>语句。</li>
<li>调用<code>list</code>函数：调用<code>list</code>函数用来将一个<code>QuerySet</code>对象转换为<code>list</code>对象也会立马执行<code>SQL</code>语句。</li>
<li>判断：如果对某个<code>QuerySet</code>进行判断，也会立马执行<code>SQL</code>语句。</li>
</ul>
<h1 id="ORM实例"><a href="#ORM实例" class="headerlink" title="ORM实例"></a>ORM实例</h1><p>ORM模型如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""学生表"""</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    gender = models.SmallIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'student'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""课程表"""</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    teacher = models.ForeignKey(<span class="string">"Teacher"</span>,on_delete=models.SET_NULL,null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'course'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Score</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""分数表"""</span></span><br><span class="line">    student = models.ForeignKey(<span class="string">"Student"</span>,on_delete=models.CASCADE)</span><br><span class="line">    course = models.ForeignKey(<span class="string">"Course"</span>,on_delete=models.CASCADE)</span><br><span class="line">    number = models.FloatField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'score'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""老师表"""</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'teacher'</span></span><br></pre></td></tr></table></figure>
<h2 id="查询平均成绩大于60分的同学的id和平均成绩；"><a href="#查询平均成绩大于60分的同学的id和平均成绩；" class="headerlink" title="查询平均成绩大于60分的同学的id和平均成绩；"></a>查询平均成绩大于60分的同学的id和平均成绩；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.annotate(avg=Avg(<span class="string">"score__number"</span>)).filter(avg__gte=<span class="number">60</span>).values(<span class="string">"id"</span>,<span class="string">"avg"</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<h2 id="查询所有同学的id、姓名、选课的数、总成绩；"><a href="#查询所有同学的id、姓名、选课的数、总成绩；" class="headerlink" title="查询所有同学的id、姓名、选课的数、总成绩；"></a>查询所有同学的id、姓名、选课的数、总成绩；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.annotate(course_nums=Count(<span class="string">"score__course"</span>),total_score=Sum(<span class="string">"score__number"</span>))</span><br><span class="line">.values(<span class="string">"id"</span>,<span class="string">"name"</span>,<span class="string">"course_nums"</span>,<span class="string">"total_score"</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<h2 id="查询姓“李”的老师的个数；"><a href="#查询姓“李”的老师的个数；" class="headerlink" title="查询姓“李”的老师的个数；"></a>查询姓“李”的老师的个数；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">teacher_nums = Teacher.objects.filter(name__startswith=<span class="string">"李"</span>).count()</span><br><span class="line">print(teacher_nums)</span><br></pre></td></tr></table></figure>
<h2 id="查询没学过“黄老师”课的同学的id、姓名；"><a href="#查询没学过“黄老师”课的同学的id、姓名；" class="headerlink" title="查询没学过“黄老师”课的同学的id、姓名；"></a>查询没学过“黄老师”课的同学的id、姓名；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.exclude(score__course__teacher__name=<span class="string">"黄老师"</span>).values(<span class="string">'id'</span>,<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<h2 id="查询学过课程id为1和2的所有同学的id、姓名；"><a href="#查询学过课程id为1和2的所有同学的id、姓名；" class="headerlink" title="查询学过课程id为1和2的所有同学的id、姓名；"></a>查询学过课程id为1和2的所有同学的id、姓名；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.filter(score__course__in=[<span class="number">1</span>,<span class="number">2</span>]).distinct().values(<span class="string">'id'</span>,<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<h2 id="查询学过“黄老师”所教的所有课的同学的学号、姓名；"><a href="#查询学过“黄老师”所教的所有课的同学的学号、姓名；" class="headerlink" title="查询学过“黄老师”所教的所有课的同学的学号、姓名；"></a>查询学过“黄老师”所教的所有课的同学的学号、姓名；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.annotate(nums=Count(<span class="string">"score__course"</span>,filter=Q(score__course__teacher__name=<span class="string">'黄老师'</span>))).filter(nums=Course.objects.filter(teacher__name=<span class="string">'黄老师'</span>).count()).values(<span class="string">'id'</span>,<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    print(row)</span><br></pre></td></tr></table></figure>
<h2 id="查询所有课程成绩小于60分的同学的id和姓名；"><a href="#查询所有课程成绩小于60分的同学的id和姓名；" class="headerlink" title="查询所有课程成绩小于60分的同学的id和姓名；"></a>查询所有课程成绩小于60分的同学的id和姓名；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">students = Student.objects.exclude(score__number__gt=<span class="number">60</span>)</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    print(student)</span><br></pre></td></tr></table></figure>
<h2 id="查询没有学全所有课的同学的id、姓名；"><a href="#查询没有学全所有课的同学的id、姓名；" class="headerlink" title="查询没有学全所有课的同学的id、姓名；"></a>查询没有学全所有课的同学的id、姓名；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">students = Student.objects.annotate(num=Count(F(<span class="string">"score__course"</span>))).filter(num__lt=Course.objects.count()).values(<span class="string">'id'</span>,<span class="string">'name'</span>)</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    print(student)</span><br></pre></td></tr></table></figure>
<h2 id="查询所有学生的姓名、平均分，并且按照平均分从高到低排序；"><a href="#查询所有学生的姓名、平均分，并且按照平均分从高到低排序；" class="headerlink" title="查询所有学生的姓名、平均分，并且按照平均分从高到低排序；"></a>查询所有学生的姓名、平均分，并且按照平均分从高到低排序；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">students = Student.objects.annotate(avg=Avg(<span class="string">"score__number"</span>)).order_by(<span class="string">"-avg"</span>).values(<span class="string">'name'</span>,<span class="string">'avg'</span>)</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    print(student)</span><br></pre></td></tr></table></figure>
<h2 id="查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分："><a href="#查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分：" class="headerlink" title="查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分："></a>查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">courses = Course.objects.annotate(min=Min(<span class="string">"score__number"</span>),max=Max(<span class="string">"score__number"</span>)).values(<span class="string">"id"</span>,<span class="string">'name'</span>,<span class="string">'min'</span>,<span class="string">'max'</span>)</span><br><span class="line"><span class="keyword">for</span> course <span class="keyword">in</span> courses:</span><br><span class="line">    print(course)</span><br></pre></td></tr></table></figure>
<h2 id="查询每门课程的平均成绩，按照平均成绩进行排序；"><a href="#查询每门课程的平均成绩，按照平均成绩进行排序；" class="headerlink" title="查询每门课程的平均成绩，按照平均成绩进行排序；"></a>查询每门课程的平均成绩，按照平均成绩进行排序；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">courses = Course.objects.annotate(avg=Avg(<span class="string">"score__number"</span>)).order_by(<span class="string">'avg'</span>).values(<span class="string">'id'</span>,<span class="string">'name'</span>,<span class="string">'avg'</span>)</span><br><span class="line"><span class="keyword">for</span> course <span class="keyword">in</span> courses:</span><br><span class="line">    print(course)</span><br></pre></td></tr></table></figure>
<h2 id="统计总共有多少女生，多少男生；"><a href="#统计总共有多少女生，多少男生；" class="headerlink" title="统计总共有多少女生，多少男生；"></a>统计总共有多少女生，多少男生；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rows = Student.objects.aggregate(male_num=Count(<span class="string">"gender"</span>,filter=Q(gender=<span class="number">1</span>)),female_num=Count(<span class="string">"gender"</span>,filter=Q(gender=<span class="number">2</span>)))</span><br><span class="line">print(rows)</span><br></pre></td></tr></table></figure>
<h2 id="将“黄老师”的每一门课程都在原来的基础之上加5分；"><a href="#将“黄老师”的每一门课程都在原来的基础之上加5分；" class="headerlink" title="将“黄老师”的每一门课程都在原来的基础之上加5分；"></a>将“黄老师”的每一门课程都在原来的基础之上加5分；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rows = Score.objects.filter(course__teacher__name=<span class="string">'黄老师'</span>).update(number=F(<span class="string">"number"</span>)+<span class="number">5</span>)</span><br><span class="line">print(rows)</span><br></pre></td></tr></table></figure>
<h2 id="查询两门以上不及格的同学的id、姓名、以及不及格课程数；"><a href="#查询两门以上不及格的同学的id、姓名、以及不及格课程数；" class="headerlink" title="查询两门以上不及格的同学的id、姓名、以及不及格课程数；"></a>查询两门以上不及格的同学的id、姓名、以及不及格课程数；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">students = Student.objects.annotate(bad_count=Count(<span class="string">"score__number"</span>,filter=Q(score__number__lt=<span class="number">60</span>))).filter(bad_count__gte=<span class="number">2</span>).values(<span class="string">'id'</span>,<span class="string">'name'</span>,<span class="string">'bad_count'</span>)</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    print(student)</span><br></pre></td></tr></table></figure>
<h2 id="查询每门课的选课人数；"><a href="#查询每门课的选课人数；" class="headerlink" title="查询每门课的选课人数；"></a>查询每门课的选课人数；</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">courses = Course.objects.annotate(student_nums=Count(<span class="string">"score__student"</span>)).values(<span class="string">'id'</span>,<span class="string">'name'</span>,<span class="string">'student_nums'</span>)</span><br><span class="line"><span class="keyword">for</span> course <span class="keyword">in</span> courses:</span><br><span class="line">    print(course)</span><br></pre></td></tr></table></figure>
<h1 id="ORM模型迁移"><a href="#ORM模型迁移" class="headerlink" title="ORM模型迁移"></a>ORM模型迁移</h1><h2 id="命令说明"><a href="#命令说明" class="headerlink" title="命令说明"></a>命令说明</h2><h3 id="makemigrations"><a href="#makemigrations" class="headerlink" title="makemigrations"></a>makemigrations</h3><p>将模型生成迁移脚本。模型所在的app，必须放在<code>settings.py</code>中的<code>INSTALLED_APPS</code>中。这个命令有以下几个常用选项：</p>
<ul>
<li><code>app_label</code>：后面可以跟一个或者多个app，那么就只会针对这几个app生成迁移脚本。如果没有任何的app_label，那么会检查<code>INSTALLED_APPS</code>中所有的app下的模型，针对每一个app都生成响应的迁移脚本。</li>
<li><code>--name</code>：给这个迁移脚本指定一个名字。</li>
<li><code>--empty</code>：生成一个空的迁移脚本。如果你想写自己的迁移脚本，可以使用这个命令来实现一个空的文件，然后自己再在文件中写迁移脚本。</li>
</ul>
<h3 id="migrate"><a href="#migrate" class="headerlink" title="migrate"></a>migrate</h3><p>将新生成的迁移脚本。映射到数据库中。创建新的表或者修改表的结构。以下一些常用的选项：</p>
<ul>
<li><code>app_label</code>：将某个app下的迁移脚本映射到数据库中。如果没有指定，那么会将所有在<code>INSTALLED_APPS</code>中的app下的模型都映射到数据库中。</li>
<li><code>app_label migrationname</code>：将某个app下指定名字的migration文件映射到数据库中。</li>
<li><code>--fake</code>：可以将指定的迁移脚本名字添加到数据库中。但是并不会把迁移脚本转换为SQL语句，修改数据库中的表。</li>
<li><code>--fake-initial</code>：将第一次生成的迁移文件版本号记录在数据库中。但并不会真正的执行迁移脚本。</li>
<li><code>showmigrations</code>：查看某个app下的迁移文件。如果后面没有app，那么将查看<code>INSTALLED_APPS</code>中所有的迁移文件。</li>
</ul>
<p>sqlmigrate：查看某个迁移文件在映射到数据库中的时候，转换的SQL语句。</p>
<h2 id="migrate原理说明"><a href="#migrate原理说明" class="headerlink" title="migrate原理说明"></a>migrate原理说明</h2><h3 id="migrate做了什么事情："><a href="#migrate做了什么事情：" class="headerlink" title="migrate做了什么事情："></a>migrate做了什么事情：</h3><ol>
<li>将相关的迁移脚本翻译成SQL语句，在数据库中执行这个SQL语句。</li>
<li>如果这个SQL语句执行没有问题，那么就会将这个迁移脚本的名字记录到<code>django_migrations</code>中。</li>
</ol>
<h3 id="migrate怎么判断哪些迁移脚本需要执行"><a href="#migrate怎么判断哪些迁移脚本需要执行" class="headerlink" title="migrate怎么判断哪些迁移脚本需要执行"></a>migrate怎么判断哪些迁移脚本需要执行</h3><p>它会将代码项目中的迁移脚本和数据库中<code>django_migrations</code>表中的迁移脚本进行对比，如果发现数据库中，没有这个迁移脚本，那么就会执行这个迁移脚本。</p>
<h2 id="执行migrate命令的时候报错的解决办法"><a href="#执行migrate命令的时候报错的解决办法" class="headerlink" title="执行migrate命令的时候报错的解决办法"></a>执行migrate命令的时候报错的解决办法</h2><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>执行<code>migrate</code>命令会报错的原因是。数据库的<code>django_migrations</code>表中的迁移版本记录和代码中的迁移脚本不一致导致的。</p>
<h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h3><h3 id="使用-fake参数："><a href="#使用-fake参数：" class="headerlink" title="使用--fake参数："></a>使用<code>--fake</code>参数：</h3><p>首先对比数据库中的迁移脚本和代码中的迁移脚本。然后找到哪个不同，之后再使用<code>--fake</code>，将代码中的迁移脚本添加到<code>django_migrations</code>中，但是并不会执行<code>sql</code>语句。这样就可以避免每次执行<code>migrate</code>的时候，都执行一些重复的迁移脚本。</p>
<h3 id="终极解决方案："><a href="#终极解决方案：" class="headerlink" title="终极解决方案："></a>终极解决方案：</h3><p>如果代码中的迁移脚本和数据库中的迁移脚本实在太多，很难找到准确出错位置。那么这时候就可以使用以下终极解决方案。就是清除之前的迁移脚本，重新映射，将出问题的app下的所有模型和数据库中表保持一致。操作步骤如下：</p>
<ol>
<li>将出问题的app下的所有模型，都和数据库中的表保持一致。</li>
<li>将出问题的app下的所有迁移脚本文件都删掉。再在<code>django_migrations</code>表中将出问题的app相关的迁移记录都删掉。</li>
<li>使用<code>makemigrations</code>，重新将模型生成一个迁移脚本。</li>
<li>使用<code>migrate --fake-initial</code>参数，将刚刚生成的迁移脚本，标记为已经完成（因为这些模型相对应的表，其实都已经在数据库中存在了，不需要重复执行了）。</li>
<li>之后可以正常映射了。</li>
</ol>
<h1 id="根据已有的表自动生成模型"><a href="#根据已有的表自动生成模型" class="headerlink" title="根据已有的表自动生成模型"></a>根据已有的表自动生成模型</h1><ol>
<li>首先需要在<code>settings.py</code>中配置好数据库相关信息</li>
<li>通过<code>python manage.py inspectdb &gt; models.py</code>，将表转换为模型后的代码，输出到<code>models.py</code>文件。如果只是想要转换一个表为模型。那么可以指定表的名字<code>python manage.py inspectdb article_article &gt; models.py</code></li>
<li><p>修正模型：新生成的ORM模型有些地方可能不太适合使用。比如模型的名字，表之间的关系等等。那么以下选项还需要重新配置一下：</p>
<ul>
<li>模型名：自动生成的模型，是根据表的名字生成的，可能不是你想要的。这时候模型的名字你可以改成任何你想要的。</li>
<li>模型所属app：根据自己的需要，将相应的模型放在对应的app中。放在同一个app中也是没有任何问题的。只是不方便管理。</li>
<li>模型外键引用：将所有使用<code>ForeignKey</code>的地方，模型引用都改成字符串。这样不会产生模型顺序的问题。另外，如果引用的模型已经移动到其他的app中了，那么还要加上这个app的前缀。</li>
<li>让<code>Django</code>管理模型：将<code>Meta</code>下的<code>managed=False</code>删掉，如果保留这个，那么以后这个模型有任何的修改，使用<code>migrate</code>都不会映射到数据库中。</li>
<li><p>当有多对多的时候，应该也要修正模型。将中间表注释了，然后使用<code>ManyToManyField</code>来实现多对多。并且，使用<code>ManyToManyField</code>生成的中间表的名字可能和数据库中那个中间表的名字不一致，这时候肯定就不能正常连接了。那么可以通过<code>db_table</code>来指定中间表的名字。示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">title = models.CharField(max_length=<span class="number">100</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">content = models.TextField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">author = models.ForeignKey(<span class="string">'front.User'</span>, models.SET_NULL, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 使用ManyToManyField模型到表，生成的中间表的规则是：article_tags</span></span><br><span class="line"><span class="comment"># 但现在已经存在的表的名字叫做：article_tag</span></span><br><span class="line"><span class="comment"># 可以使用db_table，指定中间表的名字</span></span><br><span class="line">tags = models.ManyToManyField(<span class="string">"Tag"</span>,db_table=<span class="string">'article_tag'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    db_table = <span class="string">'article'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>表名：切记不要修改表的名字。不然映射到数据库中，会发生找不到对应表的错误。</p>
</li>
</ul>
</li>
<li><p>执行命令<code>python manage.py makemigrations</code>生成初始化的迁移脚本。方便后面通过ORM来管理表。这时候还需要执行命令<code>python manage.py migrate [app_name] --fake-initial</code>，因为如果不使用<code>--fake-initial</code>，那么会将迁移脚本会映射到数据库中。这时候迁移脚本会新创建表，而这个表之前是已经存在了的，所以肯定会报错。此时我们只要将这个<code>0001-initial</code>的状态修改为已经映射，而不真正执行映射，下次再<code>migrate</code>的时候，就会忽略它。</p>
</li>
<li><p>将<code>Django</code>的核心表映射到数据库中：<code>Django</code>中还有一些核心的表也是需要创建的。不然有些功能是用不了的。比如<code>auth</code>相关表。如果这个数据库之前就是使用<code>Django</code>开发的，那么这些表就已经存在了。可以不用管了。如果之前这个数据库不是使用<code>Django</code>开发的，那么应该使用<code>migrate</code>命令将<code>Django</code>中的核心模型映射到数据库中。</p>
</li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>赞赏作者</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatreward.png" alt="WP 微信支付">
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/django/" rel="tag"># django</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/14/django笔记03/" rel="next" title="django笔记03 - 模板">
                <i class="fa fa-chevron-left"></i> django笔记03 - 模板
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/27/HTML笔记/" rel="prev" title="HTML笔记">
                HTML笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

	
	  
		<ul class="sidebar-nav motion-element">
		  <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
			文章目录
		  </li>
		  <li class="sidebar-nav-overview" data-target="site-overview-wrap">
			站点概览
		  </li>
		</ul>
	  
	

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/memory.jpg" alt="WP">
            
              <p class="site-author-name" itemprop="name">WP</p>
              <p class="site-description motion-element" itemprop="description">飞机从头顶飞过<br>流星也划破那夜空</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

	
	  
	  <!--noindex-->
		<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
		  <div class="post-toc">

			
			  
			

			
			  <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Django配置连接数据库"><span class="nav-number">1.</span> <span class="nav-text">Django配置连接数据库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#在Django中操作数据库"><span class="nav-number">2.</span> <span class="nav-text">在Django中操作数据库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Python-DB-API下规范下cursor对象常用接口："><span class="nav-number">3.</span> <span class="nav-text">Python DB API下规范下cursor对象常用接口：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ORM模型的创建和映射："><span class="nav-number">4.</span> <span class="nav-text">ORM模型的创建和映射：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建ORM模型："><span class="nav-number">4.1.</span> <span class="nav-text">创建ORM模型：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#映射模型到数据库中："><span class="nav-number">4.2.</span> <span class="nav-text">映射模型到数据库中：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ORM对数据库的基本操作"><span class="nav-number">5.</span> <span class="nav-text">ORM对数据库的基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#添加数据"><span class="nav-number">5.1.</span> <span class="nav-text">添加数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查找数据："><span class="nav-number">5.2.</span> <span class="nav-text">查找数据：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除数据"><span class="nav-number">5.3.</span> <span class="nav-text">删除数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改数据："><span class="nav-number">5.4.</span> <span class="nav-text">修改数据：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常用Field笔记："><span class="nav-number">6.</span> <span class="nav-text">常用Field笔记：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#navie时间和aware时间"><span class="nav-number">6.1.</span> <span class="nav-text">navie时间和aware时间</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pytz库"><span class="nav-number">6.1.1.</span> <span class="nav-text">pytz库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#astimezone方法："><span class="nav-number">6.1.2.</span> <span class="nav-text">astimezone方法：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#replace方法"><span class="nav-number">6.1.3.</span> <span class="nav-text">replace方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#django-utils-timezone-now方法"><span class="nav-number">6.1.4.</span> <span class="nav-text">django.utils.timezone.now方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#django-utils-timezone-localtime方法"><span class="nav-number">6.1.5.</span> <span class="nav-text">django.utils.timezone.localtime方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DateField："><span class="nav-number">6.2.</span> <span class="nav-text">DateField：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DateTimeField："><span class="nav-number">6.3.</span> <span class="nav-text">DateTimeField：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TimeField："><span class="nav-number">6.4.</span> <span class="nav-text">TimeField：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EmailField："><span class="nav-number">6.5.</span> <span class="nav-text">EmailField：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FileField："><span class="nav-number">6.6.</span> <span class="nav-text">FileField：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ImageField："><span class="nav-number">6.6.1.</span> <span class="nav-text">ImageField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FloatField："><span class="nav-number">6.6.2.</span> <span class="nav-text">FloatField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IntegerField："><span class="nav-number">6.6.3.</span> <span class="nav-text">IntegerField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BigIntegerField："><span class="nav-number">6.6.4.</span> <span class="nav-text">BigIntegerField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PositiveIntegerField："><span class="nav-number">6.6.5.</span> <span class="nav-text">PositiveIntegerField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SmallIntegerField："><span class="nav-number">6.6.6.</span> <span class="nav-text">SmallIntegerField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PositiveSmallIntegerField："><span class="nav-number">6.6.7.</span> <span class="nav-text">PositiveSmallIntegerField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TextField："><span class="nav-number">6.6.8.</span> <span class="nav-text">TextField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUIDField："><span class="nav-number">6.6.9.</span> <span class="nav-text">UUIDField：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URLField："><span class="nav-number">6.6.10.</span> <span class="nav-text">URLField：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Field常用的参数"><span class="nav-number">6.7.</span> <span class="nav-text">Field常用的参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#null："><span class="nav-number">6.7.1.</span> <span class="nav-text">null：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blank："><span class="nav-number">6.7.2.</span> <span class="nav-text">blank：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#db-column："><span class="nav-number">6.7.3.</span> <span class="nav-text">db_column：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#default："><span class="nav-number">6.7.4.</span> <span class="nav-text">default：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#primary-key："><span class="nav-number">6.7.5.</span> <span class="nav-text">primary_key：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unique："><span class="nav-number">6.7.6.</span> <span class="nav-text">unique：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型中Meta配置"><span class="nav-number">6.8.</span> <span class="nav-text">模型中Meta配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#db-table："><span class="nav-number">6.8.1.</span> <span class="nav-text">db_table：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ordering："><span class="nav-number">6.8.2.</span> <span class="nav-text">ordering：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#外键和表关系"><span class="nav-number">7.</span> <span class="nav-text">外键和表关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#外键"><span class="nav-number">7.1.</span> <span class="nav-text">外键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外键删除操作"><span class="nav-number">7.2.</span> <span class="nav-text">外键删除操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表关系笔记："><span class="nav-number">7.3.</span> <span class="nav-text">表关系笔记：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一对多："><span class="nav-number">7.3.1.</span> <span class="nav-text">一对多：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一对一："><span class="nav-number">7.3.2.</span> <span class="nav-text">一对一：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多对多："><span class="nav-number">7.3.3.</span> <span class="nav-text">多对多：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查询条件笔记："><span class="nav-number">8.</span> <span class="nav-text">查询条件笔记：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exact"><span class="nav-number">8.1.</span> <span class="nav-text">exact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iexact"><span class="nav-number">8.2.</span> <span class="nav-text">iexact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QuerySet-query"><span class="nav-number">8.3.</span> <span class="nav-text">QuerySet.query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#contains"><span class="nav-number">8.4.</span> <span class="nav-text">contains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#icontains"><span class="nav-number">8.5.</span> <span class="nav-text">icontains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#contains和iexact区别"><span class="nav-number">8.6.</span> <span class="nav-text">contains和iexact区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in"><span class="nav-number">8.7.</span> <span class="nav-text">in</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gt、gte、lt、lte"><span class="nav-number">8.8.</span> <span class="nav-text">gt、gte、lt、lte</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#startswith、istartswith、endswith、iendswith"><span class="nav-number">8.9.</span> <span class="nav-text">startswith、istartswith、endswith、iendswith</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时间查询条件"><span class="nav-number">8.10.</span> <span class="nav-text">时间查询条件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#range"><span class="nav-number">8.10.1.</span> <span class="nav-text">range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#date"><span class="nav-number">8.10.2.</span> <span class="nav-text">date</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#year-month-day"><span class="nav-number">8.10.3.</span> <span class="nav-text">year/month/day</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#week-day"><span class="nav-number">8.10.4.</span> <span class="nav-text">week_day</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#time"><span class="nav-number">8.10.5.</span> <span class="nav-text">time</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#regex和iregex"><span class="nav-number">8.11.</span> <span class="nav-text">regex和iregex</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#聚合函数笔记："><span class="nav-number">9.</span> <span class="nav-text">聚合函数笔记：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#aggregate"><span class="nav-number">9.1.</span> <span class="nav-text">aggregate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#annotate"><span class="nav-number">9.2.</span> <span class="nav-text">annotate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Count"><span class="nav-number">9.3.</span> <span class="nav-text">Count</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Max和Min"><span class="nav-number">9.4.</span> <span class="nav-text">Max和Min</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sum"><span class="nav-number">9.5.</span> <span class="nav-text">Sum</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#F表达式和Q表达式"><span class="nav-number">10.</span> <span class="nav-text">F表达式和Q表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#F表达式"><span class="nav-number">10.1.</span> <span class="nav-text">F表达式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q表达式"><span class="nav-number">10.2.</span> <span class="nav-text">Q表达式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QuerySet-API："><span class="nav-number">11.</span> <span class="nav-text">QuerySet API：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型-objects："><span class="nav-number">11.1.</span> <span class="nav-text">模型.objects：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filter-exclude-annotate：过滤-排除满足条件的-给模型添加新的字段。"><span class="nav-number">11.2.</span> <span class="nav-text">filter/exclude/annotate：过滤/排除满足条件的/给模型添加新的字段。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#order-by："><span class="nav-number">11.3.</span> <span class="nav-text">order_by：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#values"><span class="nav-number">11.4.</span> <span class="nav-text">values</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#values-list"><span class="nav-number">11.5.</span> <span class="nav-text">values_list</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#all方法"><span class="nav-number">11.6.</span> <span class="nav-text">all方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-related"><span class="nav-number">11.7.</span> <span class="nav-text">select_related</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prefetch-related"><span class="nav-number">11.8.</span> <span class="nav-text">prefetch_related</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#defer和only"><span class="nav-number">11.9.</span> <span class="nav-text">defer和only</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get方法"><span class="nav-number">11.10.</span> <span class="nav-text">get方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create方法"><span class="nav-number">11.11.</span> <span class="nav-text">create方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get-or-create"><span class="nav-number">11.12.</span> <span class="nav-text">get_or_create</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bulk-create"><span class="nav-number">11.13.</span> <span class="nav-text">bulk_create</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#count"><span class="nav-number">11.14.</span> <span class="nav-text">count</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#firtst和last"><span class="nav-number">11.15.</span> <span class="nav-text">firtst和last</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#aggregate-1"><span class="nav-number">11.16.</span> <span class="nav-text">aggregate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exists"><span class="nav-number">11.17.</span> <span class="nav-text">exists</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#distinct"><span class="nav-number">11.18.</span> <span class="nav-text">distinct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update"><span class="nav-number">11.19.</span> <span class="nav-text">update</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#delete"><span class="nav-number">11.20.</span> <span class="nav-text">delete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#切片操作"><span class="nav-number">11.21.</span> <span class="nav-text">切片操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么时候Django会将QuerySet转换为SQL去执行"><span class="nav-number">11.22.</span> <span class="nav-text">什么时候Django会将QuerySet转换为SQL去执行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ORM实例"><span class="nav-number">12.</span> <span class="nav-text">ORM实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#查询平均成绩大于60分的同学的id和平均成绩；"><span class="nav-number">12.1.</span> <span class="nav-text">查询平均成绩大于60分的同学的id和平均成绩；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询所有同学的id、姓名、选课的数、总成绩；"><span class="nav-number">12.2.</span> <span class="nav-text">查询所有同学的id、姓名、选课的数、总成绩；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询姓“李”的老师的个数；"><span class="nav-number">12.3.</span> <span class="nav-text">查询姓“李”的老师的个数；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询没学过“黄老师”课的同学的id、姓名；"><span class="nav-number">12.4.</span> <span class="nav-text">查询没学过“黄老师”课的同学的id、姓名；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询学过课程id为1和2的所有同学的id、姓名；"><span class="nav-number">12.5.</span> <span class="nav-text">查询学过课程id为1和2的所有同学的id、姓名；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询学过“黄老师”所教的所有课的同学的学号、姓名；"><span class="nav-number">12.6.</span> <span class="nav-text">查询学过“黄老师”所教的所有课的同学的学号、姓名；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询所有课程成绩小于60分的同学的id和姓名；"><span class="nav-number">12.7.</span> <span class="nav-text">查询所有课程成绩小于60分的同学的id和姓名；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询没有学全所有课的同学的id、姓名；"><span class="nav-number">12.8.</span> <span class="nav-text">查询没有学全所有课的同学的id、姓名；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询所有学生的姓名、平均分，并且按照平均分从高到低排序；"><span class="nav-number">12.9.</span> <span class="nav-text">查询所有学生的姓名、平均分，并且按照平均分从高到低排序；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分："><span class="nav-number">12.10.</span> <span class="nav-text">查询各科成绩的最高和最低分，以如下形式显示：课程ID，课程名称，最高分，最低分：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询每门课程的平均成绩，按照平均成绩进行排序；"><span class="nav-number">12.11.</span> <span class="nav-text">查询每门课程的平均成绩，按照平均成绩进行排序；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#统计总共有多少女生，多少男生；"><span class="nav-number">12.12.</span> <span class="nav-text">统计总共有多少女生，多少男生；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#将“黄老师”的每一门课程都在原来的基础之上加5分；"><span class="nav-number">12.13.</span> <span class="nav-text">将“黄老师”的每一门课程都在原来的基础之上加5分；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询两门以上不及格的同学的id、姓名、以及不及格课程数；"><span class="nav-number">12.14.</span> <span class="nav-text">查询两门以上不及格的同学的id、姓名、以及不及格课程数；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询每门课的选课人数；"><span class="nav-number">12.15.</span> <span class="nav-text">查询每门课的选课人数；</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ORM模型迁移"><span class="nav-number">13.</span> <span class="nav-text">ORM模型迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#命令说明"><span class="nav-number">13.1.</span> <span class="nav-text">命令说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#makemigrations"><span class="nav-number">13.1.1.</span> <span class="nav-text">makemigrations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#migrate"><span class="nav-number">13.1.2.</span> <span class="nav-text">migrate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#migrate原理说明"><span class="nav-number">13.2.</span> <span class="nav-text">migrate原理说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#migrate做了什么事情："><span class="nav-number">13.2.1.</span> <span class="nav-text">migrate做了什么事情：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#migrate怎么判断哪些迁移脚本需要执行"><span class="nav-number">13.2.2.</span> <span class="nav-text">migrate怎么判断哪些迁移脚本需要执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行migrate命令的时候报错的解决办法"><span class="nav-number">13.3.</span> <span class="nav-text">执行migrate命令的时候报错的解决办法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原因"><span class="nav-number">13.3.1.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决办法："><span class="nav-number">13.3.2.</span> <span class="nav-text">解决办法：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-fake参数："><span class="nav-number">13.3.3.</span> <span class="nav-text">使用--fake参数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#终极解决方案："><span class="nav-number">13.3.4.</span> <span class="nav-text">终极解决方案：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#根据已有的表自动生成模型"><span class="nav-number">14.</span> <span class="nav-text">根据已有的表自动生成模型</span></a></li></ol></div>
			

		  </div>
		</section>
	  <!--/noindex-->
	  
	

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WP</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">354k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">10:44</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>



  
  











  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/three/three.min.js"></script>

  
  <script src="/lib/three/three-waves.min.js"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  




  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail';
  guest = guest.split(',').filter(function (item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'IrCihvbStzYVX1cVfwYfUjpt-gzGzoHsz',
    appKey: 'U1FLNq52nK27I2BQq9TCSAdt',
    placeholder: '来玩啊',
    avatar: 'mp',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true
  });
</script>



  





  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
